# Data Model: OpenAI Agent Builder Integration

**Feature**: OpenAI Agent Builder Integration  
**Date**: 2025-01-27

## Entities & Relationships

### 1. ChatMessage

**Description**: Represents a single message in a chat conversation between user and agent.

**Attributes**:
- **id**: Unique identifier for the message (string, UUID)
- **content**: The message text (string)
- **role**: Message sender - "user" or "assistant" (enum)
- **timestamp**: When the message was sent (datetime)
- **conversationId**: Links message to a conversation thread (string, optional)
- **ragContextUsed**: Whether RAG context was used in generating this response (boolean, optional)
- **error**: Error message if message failed to send (string, optional)

**Relationships**:
- `ChatMessage` `BELONGS_TO` `Conversation`
- `ChatMessage` `MAY_USE` `RAGContext`

**Validation Rules**:
- `content` must not be empty for user messages
- `role` must be either "user" or "assistant"
- `timestamp` must be a valid datetime

---

### 2. Conversation

**Description**: Represents a chat session with a unique thread ID for maintaining context.

**Attributes**:
- **conversationId**: Unique identifier for the conversation thread (string, UUID)
- **createdAt**: When conversation started (datetime)
- **lastActivityAt**: Timestamp of most recent message (datetime)
- **messageCount**: Number of messages in conversation (integer)
- **ragContextAvailable**: Whether RAG context was available for this conversation (boolean)

**Relationships**:
- `Conversation` `HAS_MANY` `ChatMessage`
- `Conversation` `USES` `AgentWorkflow`

**State Transitions**:
- **Initial**: Conversation created with first user message
- **Active**: Messages being exchanged
- **Ended**: User cleared conversation or started new one

**Validation Rules**:
- `conversationId` must be unique
- `createdAt` must be before or equal to `lastActivityAt`

---

### 3. RAGContext

**Description**: Retrieved book content chunks from RAG server that provide context for agent responses.

**Attributes**:
- **chunks**: Array of text chunks retrieved from RAG server (array of strings)
- **query**: Original user query that triggered retrieval (string)
- **retrievedAt**: When context was retrieved (datetime)
- **sourceFiles**: Array of source file names where chunks originated (array of strings, optional)

**Relationships**:
- `RAGContext` `ENHANCES` `AgentResponse`
- `RAGContext` `RETRIEVED_FROM` `RAGServer`

**Validation Rules**:
- `chunks` array must not be empty if retrieval was successful
- `query` must match the user's original question

---

### 4. AgentResponse

**Description**: Response generated by OpenAI Agent Builder Agent, potentially enhanced with RAG context.

**Attributes**:
- **responseText**: The agent's response content (string)
- **workflowId**: OpenAI Agent Builder workflow ID used (string)
- **threadId**: Conversation thread ID for context (string, optional)
- **ragContextIncluded**: Whether RAG context was included in workflow input (boolean)
- **responseTime**: Time taken to generate response in milliseconds (integer)
- **error**: Error message if response generation failed (string, optional)

**Relationships**:
- `AgentResponse` `GENERATED_BY` `AgentWorkflow`
- `AgentResponse` `MAY_USE` `RAGContext`
- `AgentResponse` `RESPONDS_TO` `UserQuery`

**Validation Rules**:
- `responseText` must not be empty if response was successful
- `workflowId` must be a valid OpenAI workflow identifier
- `responseTime` must be non-negative

---

### 5. AgentWorkflow

**Description**: Configuration for OpenAI Agent Builder Agent workflow.

**Attributes**:
- **workflowId**: OpenAI Agent Builder workflow ID (string)
- **name**: Human-readable workflow name (string, optional)
- **description**: What the workflow does (string, optional)
- **ragIntegrationEnabled**: Whether workflow accepts RAG context (boolean)

**Relationships**:
- `AgentWorkflow` `GENERATES` `AgentResponse`
- `AgentWorkflow` `CONFIGURED_IN` `SystemConfiguration`

**Validation Rules**:
- `workflowId` must be provided and valid
- `ragIntegrationEnabled` determines if RAG context should be passed

---

### 6. UserQuery

**Description**: User's question or input to the chat interface.

**Attributes**:
- **queryText**: The user's question (string)
- **conversationId**: Conversation thread this query belongs to (string, optional)
- **timestamp**: When query was submitted (datetime)
- **sessionId**: Browser session identifier (string)

**Relationships**:
- `UserQuery` `TRIGGERS` `RAGContext` retrieval
- `UserQuery` `SENT_TO` `AgentWorkflow`
- `UserQuery` `GENERATES` `AgentResponse`

**Validation Rules**:
- `queryText` must not be empty
- `queryText` length should be reasonable (e.g., max 2000 characters)
- `timestamp` must be current or recent

---

## Data Flow

### Query Processing Flow

```
UserQuery (user submits question)
  ↓
RAGContext (retrieve from RAG server /search_book)
  ↓
AgentWorkflow (combine query + RAG context)
  ↓
AgentResponse (generate response)
  ↓
ChatMessage (store in conversation)
```

### Conversation State Management

```
Conversation (created on first message)
  ↓
ChatMessage[] (messages stored in sessionStorage + sent to agent)
  ↓
Conversation (updated with lastActivityAt, messageCount)
```

## Storage Strategy

**Client-Side (Browser)**:
- `ChatMessage[]`: Stored in `sessionStorage` for conversation history
- `Conversation.conversationId`: Stored in `sessionStorage`
- `sessionId`: Generated and stored in `sessionStorage`

**Server-Side (Backend)**:
- No persistent storage required for MVP
- Conversation context maintained via OpenAI thread IDs
- RAG server already has book content in Neon PostgreSQL + Qdrant

**Future Considerations**:
- Optional: Store conversation history in database for cross-device access
- Optional: Analytics on query patterns and response quality

## Validation Summary

All entities have validation rules to ensure:
- Data integrity (required fields, format checks)
- Business logic compliance (e.g., timestamps, relationships)
- User experience (e.g., query length limits)

Error states are represented as optional error attributes on relevant entities, allowing graceful degradation per FR-009.

